<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Raindrops</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            padding: 50px;
        }
        
        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            font-size: 1.2em;
            margin-bottom: 30px;
        }
        
        .content {
            margin: 30px 0;
        }
        
        .content p {
            margin-bottom: 15px;
            text-align: justify;
        }
        
        .magic-key-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin: 30px 0;
            border-left: 4px solid #667eea;
        }
        
        .magic-key-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button, .btn {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: background 0.3s;
        }
        
        button:hover, .btn:hover {
            background: #5568d3;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        
        /* Authenticated user view */
        .authenticated-view {
            display: none;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .card p {
            color: #666;
            margin: 0;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .stat-box {
            flex: 1;
            min-width: 150px;
            background: #667eea;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-box .number {
            font-size: 2em;
            font-weight: bold;
        }
        
        .stat-box .label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logout-btn {
            background: #dc3545;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Unauthenticated View -->
        <div id="unauthenticated-view">
            <h1>üåßÔ∏è Project Raindrops</h1>
            <p class="subtitle">The project is in closed beta - any comments to ayourtch at gmail</p>
            
            <div class="content">
                <p>
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et 
                    dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip 
                    ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu 
                    fugiat nulla pariatur.
                </p>
                <p>
                    Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est 
                    laborum. Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, 
                    totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt 
                    explicabo.
                </p>
            </div>
            
            <div class="magic-key-section">
                <h2>üîë Magic Key Access</h2>
                <p>
                    Enter the magic key if you have one.
                </p>
                <div class="input-group">
                    <input type="text" id="magic-key" placeholder="Enter your Magic Key" />
                    <button onclick="submitMagicKey()">Access</button>
                </div>
                <div id="magic-key-error" class="error"></div>
            </div>
            
            <div class="button-group">
                <a href="/auth/login" class="btn">Login</a>
            </div>
        </div>
        
        <!-- Authenticated View -->
        <div id="authenticated-view" class="authenticated-view">
            <div class="user-info">
                <div>
                    <strong>Welcome back, <span id="user-name">User</span>!</strong>
                </div>
                <form action="/auth/logout" method="post" style="display: inline;">
                    <button type="submit" class="btn logout-btn">Logout</button>
                </form>
            </div>
            
            <h1>üåßÔ∏è Project Raindrops Dashboard</h1>
            
            <div class="stats">
                <div class="stat-box">
                    <div class="number" id="active-surveys">0</div>
                    <div class="label">Active Surveys</div>
                </div>
                <div class="stat-box">
                    <div class="number" id="total-measurements">0</div>
                    <div class="label">Total Measurements</div>
                </div>
                <div class="stat-box">
                    <div class="number" id="active-surveyors">0</div>
                    <div class="label">Active Surveyors</div>
                </div>
            </div>
            
            <div class="content">
                <h2 style="color: #667eea; margin: 30px 0 15px 0;">Quick Actions</h2>
                <div class="dashboard-grid">
                    <div class="card">
                        <h3>üìä View Dashboards</h3>
                        <p>Monitor active network measurements and survey progress in real-time.</p>
                        <a href="/static/dashboard.html" class="btn" style="margin-top: 15px; display: inline-block;">Open Dashboard</a>
                    </div>
                    <div class="card">
                        <h3>üß™ Run Network Test</h3>
                        <p>Perform network measurements and contribute to survey data.</p>
                        <a href="/static/nettest.html" class="btn" style="margin-top: 15px; display: inline-block;">Start Test</a>
                    </div>
                    <div class="card">
                        <h3>üìà View Statistics</h3>
                        <p>Analyze survey results and network performance metrics.</p>
                        <button class="btn" style="margin-top: 15px;" onclick="alert('Coming soon!')">View Stats</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Check if user is authenticated
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/status');
                if (response.ok) {
                    const data = await response.json();
                    if (data.authenticated) {
                        showAuthenticatedView(data);
                        return;
                    }
                }
            } catch (e) {
                console.log('Not authenticated');
            }
            showUnauthenticatedView();
        }
        
        function showAuthenticatedView(data) {
            document.getElementById('unauthenticated-view').style.display = 'none';
            document.getElementById('authenticated-view').style.display = 'block';
            
            if (data.user && data.user.name) {
                document.getElementById('user-name').textContent = data.user.name;
            }
            
            // Load statistics (mock data for now)
            document.getElementById('active-surveys').textContent = data.stats?.active_surveys || '0';
            document.getElementById('total-measurements').textContent = data.stats?.total_measurements || '0';
            document.getElementById('active-surveyors').textContent = data.stats?.active_surveyors || '0';
        }
        
        function showUnauthenticatedView() {
            document.getElementById('unauthenticated-view').style.display = 'block';
            document.getElementById('authenticated-view').style.display = 'none';
        }
        
        async function submitMagicKey() {
            const magicKey = document.getElementById('magic-key').value.trim();
            const errorEl = document.getElementById('magic-key-error');
            
            if (!magicKey) {
                errorEl.textContent = 'Please enter a Magic Key';
                errorEl.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch('/api/auth/magic-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ magic_key: magicKey })
                });
                
                if (response.ok) {
                    // Redirect to network test page
                    window.location.href = '/static/nettest.html';
                } else {
                    const error = await response.json();
                    errorEl.textContent = error.message || 'Invalid Magic Key';
                    errorEl.style.display = 'block';
                }
            } catch (e) {
                errorEl.textContent = 'Error validating Magic Key. Please try again.';
                errorEl.style.display = 'block';
            }
        }
        
        // Check auth status on page load
        checkAuth();
    </script>
</body>
</html>
