<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Raindrops</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 900px;
            width: 100%;
            border-top: 4px solid #2196F3;
        }
        
        /* Header */
        .header {
            padding: 40px 40px 20px 40px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #2196F3 0%, #FF9800 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-icon svg {
            width: 28px;
            height: 28px;
            fill: white;
        }
        
        .logo h1 {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }
        
        .header-badges {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 12px;
        }
        
        .badge {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 3px;
            font-weight: 500;
        }
        
        .badge-ipv4 {
            background-color: rgba(33, 150, 243, 0.1);
            color: #2196F3;
            border: 1px solid rgba(33, 150, 243, 0.3);
        }
        
        .badge-ipv6 {
            background-color: rgba(255, 152, 0, 0.1);
            color: #FF9800;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }
        
        .subtitle {
            color: #666;
            font-size: 14px;
            margin-top: 8px;
        }
        
        /* Content */
        .content {
            padding: 30px 40px;
        }
        
        .content p {
            margin-bottom: 15px;
            color: #666;
        }
        
        /* Magic Key Section */
        .magic-key-section {
            background: #fafafa;
            padding: 24px;
            border-radius: 6px;
            margin: 24px 0;
            border-left: 4px solid #2196F3;
        }
        
        .magic-key-section h2 {
            color: #333;
            margin-bottom: 12px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .magic-key-section h2 svg {
            width: 20px;
            height: 20px;
            fill: #2196F3;
        }
        
        .magic-key-section p {
            color: #666;
            font-size: 14px;
            margin-bottom: 16px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 12px 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .btn:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background-color: #2196F3;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1976D2;
        }
        
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #eee;
        }
        
        /* Error message */
        .error {
            background: #ffebee;
            border: 1px solid #ef9a9a;
            color: #c62828;
            padding: 12px;
            border-radius: 4px;
            margin-top: 12px;
            font-size: 14px;
            display: none;
        }
        
        /* Authenticated View */
        .authenticated-view {
            display: none;
        }
        
        .user-info {
            background: #fafafa;
            padding: 16px 20px;
            border-radius: 6px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #eee;
        }
        
        .user-info strong {
            color: #333;
        }
        
        /* Stats */
        .stats {
            display: flex;
            gap: 16px;
            margin: 24px 0;
            flex-wrap: wrap;
        }
        
        .stat-box {
            flex: 1;
            min-width: 140px;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-box:nth-child(1) {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
        }
        
        .stat-box:nth-child(2) {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            color: white;
        }
        
        .stat-box:nth-child(3) {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
        }
        
        .stat-box .number {
            font-size: 32px;
            font-weight: bold;
        }
        
        .stat-box .label {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 4px;
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }
        
        .card {
            background: #fafafa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }
        
        .card:nth-child(2) {
            border-left-color: #4CAF50;
        }
        
        .card:nth-child(3) {
            border-left-color: #FF9800;
        }
        
        .card h3 {
            color: #333;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .card p {
            color: #666;
            font-size: 13px;
            margin: 0 0 16px 0;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 20px 40px;
            color: #999;
            font-size: 12px;
            border-top: 1px solid #eee;
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            .container {
                margin: 10px;
            }
            
            .header, .content {
                padding: 24px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .stats {
                flex-direction: column;
            }
            
            .stat-box {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Unauthenticated View -->
        <div id="unauthenticated-view">
            <div class="header">
                <div class="logo">
                    <div class="logo-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 3C7.03 3 3 7.03 3 12s4.03 9 9 9 9-4.03 9-9-4.03-9-9-9zm0 16c-3.86 0-7-3.14-7-7s3.14-7 7-7 7 3.14 7 7-3.14 7-7 7z"/>
                            <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zm0 8c-1.65 0-3-1.35-3-3s1.35-3 3-3 3 1.35 3 3-1.35 3-3 3z"/>
                            <circle cx="12" cy="12" r="1.5"/>
                        </svg>
                    </div>
                    <h1>Project Raindrops</h1>
                </div>
                <div class="header-badges">
                    <span class="badge badge-ipv4">IPv4</span>
                    <span class="badge badge-ipv6">IPv6</span>
                </div>
                <p class="subtitle">The project is in closed beta - any comments to ayourtch at gmail</p>
            </div>
            
            <div class="content">
                <p>
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et 
                    dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip 
                    ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu 
                    fugiat nulla pariatur.
                </p>
                <p>
                    Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est 
                    laborum. Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, 
                    totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt 
                    explicabo.
                </p>
                
                <div class="magic-key-section">
                    <h2>
                        <svg viewBox="0 0 24 24">
                            <path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                        </svg>
                        Magic Key Access
                    </h2>
                    <p>Enter the magic key if you have one.</p>
                    <div class="input-group">
                        <input type="text" id="magic-key" placeholder="Enter your Magic Key" />
                        <button class="btn btn-primary" onclick="submitMagicKey()">Access</button>
                    </div>
                    <div id="magic-key-error" class="error"></div>
                </div>
                
                <div class="button-group">
                    <a href="/auth/login" class="btn btn-primary">Login</a>
                </div>
            </div>
            
            <div class="footer">
                Powered by Project Raindrops Authentication
            </div>
        </div>
        
        <!-- Authenticated View -->
        <div id="authenticated-view" class="authenticated-view">
            <div class="header">
                <div class="logo">
                    <div class="logo-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 3C7.03 3 3 7.03 3 12s4.03 9 9 9 9-4.03 9-9-4.03-9-9-9zm0 16c-3.86 0-7-3.14-7-7s3.14-7 7-7 7 3.14 7 7-3.14 7-7 7z"/>
                            <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zm0 8c-1.65 0-3-1.35-3-3s1.35-3 3-3 3 1.35 3 3-1.35 3-3 3z"/>
                            <circle cx="12" cy="12" r="1.5"/>
                        </svg>
                    </div>
                    <h1>Project Raindrops</h1>
                </div>
                <div class="header-badges">
                    <span class="badge badge-ipv4">IPv4</span>
                    <span class="badge badge-ipv6">IPv6</span>
                </div>
            </div>
            
            <div class="content">
                <div class="user-info">
                    <div>
                        <strong>Welcome back, <span id="user-name">User</span>!</strong>
                    </div>
                    <form action="/auth/logout" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-danger">Logout</button>
                    </form>
                </div>
                
                <div class="stats">
                    <div class="stat-box">
                        <div class="number" id="active-surveys">0</div>
                        <div class="label">Active Surveys</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="total-measurements">0</div>
                        <div class="label">Total Measurements</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="active-surveyors">0</div>
                        <div class="label">Active Surveyors</div>
                    </div>
                </div>
                
                <h2 style="color: #333; font-size: 18px; margin: 24px 0 16px 0;">Quick Actions</h2>
                <div class="dashboard-grid">
                    <div class="card">
                        <h3>View Dashboards</h3>
                        <p>Monitor active network measurements and survey progress in real-time.</p>
                        <a href="/static/dashboard.html" class="btn btn-primary">Open Dashboard</a>
                    </div>
                    <div class="card">
                        <h3>Run Network Test</h3>
                        <p>Perform network measurements and contribute to survey data.</p>
                        <a href="/static/nettest.html" class="btn btn-primary">Start Test</a>
                    </div>
                    <div class="card">
                        <h3>Survey Data</h3>
                        <p>Browse survey sessions, recordings, and latency metrics.</p>
                        <a href="/admin/surveys" class="btn btn-primary">View Surveys</a>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                Powered by Project Raindrops Authentication
            </div>
        </div>
    </div>
    
    <script>
        // Check if user is authenticated
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/status');
                if (response.ok) {
                    const data = await response.json();
                    if (data.authenticated) {
                        showAuthenticatedView(data);
                        return;
                    }
                }
            } catch (e) {
                console.log('Not authenticated');
            }
            showUnauthenticatedView();
        }
        
        function showAuthenticatedView(data) {
            document.getElementById('unauthenticated-view').style.display = 'none';
            document.getElementById('authenticated-view').style.display = 'block';
            
            if (data.user && data.user.name) {
                document.getElementById('user-name').textContent = data.user.name;
            }
            
            // Load statistics (mock data for now)
            document.getElementById('active-surveys').textContent = data.stats?.active_surveys || '0';
            document.getElementById('total-measurements').textContent = data.stats?.total_measurements || '0';
            document.getElementById('active-surveyors').textContent = data.stats?.active_surveyors || '0';
        }
        
        function showUnauthenticatedView() {
            document.getElementById('unauthenticated-view').style.display = 'block';
            document.getElementById('authenticated-view').style.display = 'none';
        }
        
        async function submitMagicKey() {
            const magicKey = document.getElementById('magic-key').value.trim();
            const errorEl = document.getElementById('magic-key-error');
            
            if (!magicKey) {
                errorEl.textContent = 'Please enter a Magic Key';
                errorEl.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch('/api/auth/magic-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ magic_key: magicKey })
                });
                
                if (response.ok) {
                    // Redirect to network test page
                    window.location.href = '/static/nettest.html';
                } else {
                    const error = await response.json();
                    errorEl.textContent = error.message || 'Invalid Magic Key';
                    errorEl.style.display = 'block';
                }
            } catch (e) {
                errorEl.textContent = 'Error validating Magic Key. Please try again.';
                errorEl.style.display = 'block';
            }
        }
        
        // Check auth status on page load
        checkAuth();
    </script>
</body>
</html>
